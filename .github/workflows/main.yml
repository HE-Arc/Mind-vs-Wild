name: Deploy Django + Vue.js

on:
  push:
    branches:
      - main

jobs:
  Deploy:
    runs-on: self-hosted

    steps:
      - name: Deploying Django + Vue.js app
        run: |
          cd /home/django/project
          
          if [ -d "./app" ]; then
            cd ./app
            git pull origin main
          else
            git clone https://github.com/HE-Arc/Mind-vs-Wild.git app
            cd ./app
          fi
          
          export PIPENV_VENV_IN_PROJECT=1
          export VIRTUAL_ENV=/home/django/project/app/.venv
          export PATH="$VIRTUAL_ENV/bin:$PATH"

          echo "Using virtual environment: $VIRTUAL_ENV"
          which python  # Devrait afficher /home/django/project/app/.venv/bin/python
          
          pipenv install --deploy --ignore-pipfile
          
          pipenv run python -m django --version
          
          pipenv run python manage.py migrate --noinput
          pipenv run python manage.py collectstatic --noinput
          
          cd ../frontend
          npm install
          npm run build
          cd ..
          
          sudo systemctl restart gunicorn
          sudo systemctl restart nginx
          
          echo "Success"
